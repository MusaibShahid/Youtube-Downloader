<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 4K/8K Downloader</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h1 class="display-4 mb-3">
                        <i class="fas fa-video text-danger"></i> YouTube Downloader
                    </h1>
                    <p class="lead">Download YouTube videos in 4K/8K quality with real-time progress</p>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'info' }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }}"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- URL Input Card -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-link"></i> Step 1: Enter YouTube URL
                        </h5>
                        <div class="input-group">
                            <input type="url" 
                                   id="videoUrl" 
                                   class="form-control" 
                                   placeholder="https://www.youtube.com/watch?v=..." 
                                   required>
                            <button class="btn btn-primary" type="button" id="fetchInfoBtn">
                                <i class="fas fa-search"></i> Fetch Video Info
                            </button>
                        </div>
                        <div class="form-text">
                            Paste the YouTube video URL and click "Fetch Video Info" to see available options
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="text-center mb-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Fetching video information...</p>
                </div>

                <!-- Video Info Card (Hidden initially) -->
                <div id="videoInfoCard" class="card mb-4" style="display: none;">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <img id="videoThumbnail" src="" class="img-fluid rounded" alt="Video Thumbnail">
                            </div>
                            <div class="col-md-8">
                                <h5 id="videoTitle" class="card-title"></h5>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-user"></i> <span id="videoAuthor"></span><br>
                                        <i class="fas fa-eye"></i> <span id="videoViews"></span> views<br>
                                        <i class="fas fa-clock"></i> <span id="videoDuration"></span><br>
                                    </small>
                                </p>
                                <p id="videoDescription" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Download Options Card (Hidden initially) -->
                <div id="downloadOptionsCard" class="card mb-4" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-cog"></i> Step 2: Choose Download Options
                        </h5>

                        <!-- Download Location -->
                        <div class="mb-3">
                            <label for="downloadLocation" class="form-label">
                                <i class="fas fa-folder"></i> Download Location
                            </label>
                            <select id="downloadLocation" class="form-select">
                                {% for key, path in locations.items() %}
                                <option value="{{ key }}">{{ key.title() }} ({{ path }})</option>
                                {% endfor %}
      </select>
                        </div>

                        <!-- Download Type Tabs -->
                        <ul class="nav nav-tabs mb-3" id="downloadTypeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button" role="tab">
                                    <i class="fas fa-video"></i> Video + Audio
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="video-only-tab" data-bs-toggle="tab" data-bs-target="#video-only-pane" type="button" role="tab">
                                    <i class="fas fa-film"></i> Video Only
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="audio-tab" data-bs-toggle="tab" data-bs-target="#audio-pane" type="button" role="tab">
                                    <i class="fas fa-music"></i> Audio Only
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="downloadTypeContent">
                            <!-- Video + Audio Tab -->
                            <div class="tab-pane fade show active" id="video-pane" role="tabpanel">
                                <h6>Progressive Streams (Video + Audio)</h6>
                                <div id="progressiveStreams" class="mb-3"></div>
                                
                                <h6>High Quality Streams (Requires Merging)</h6>
                                <div id="adaptiveStreams"></div>
                            </div>

                            <!-- Video Only Tab -->
                            <div class="tab-pane fade" id="video-only-pane" role="tabpanel">
                                <h6>Video Only Streams</h6>
                                <div id="videoOnlyStreams"></div>
                            </div>

                            <!-- Audio Only Tab -->
                            <div class="tab-pane fade" id="audio-pane" role="tabpanel">
                                <h6>Audio Only Streams</h6>
                                <div id="audioStreams"></div>
                            </div>
                        </div>

                        <!-- Download Button -->
                        <div class="text-center mt-4">
                            <button id="downloadBtn" class="btn btn-danger btn-lg" disabled>
                                <i class="fas fa-download"></i> Start Download
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Progress Card (Hidden initially) -->
                <div id="progressCard" class="card" style="display: none;">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-download"></i> Download Progress
                        </h5>
                        
                        <!-- Progress Bar -->
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                0%
                            </div>
                        </div>

                        <!-- Status Text -->
                        <div id="statusText" class="mb-3">
                            <i class="fas fa-spinner fa-spin"></i> Initializing download...
                        </div>

                        <!-- Download Button (hidden initially) -->
                        <div id="downloadSection" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> Download completed successfully!
                            </div>
                            <a href="#" id="downloadFileBtn" class="btn btn-success btn-lg">
                                <i class="fas fa-download"></i> Download File
                            </a>
                        </div>

                        <!-- Error Section (hidden initially) -->
                        <div id="errorSection" style="display: none;">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <span id="errorMessage">An error occurred during download.</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-3">
                            <button class="btn btn-secondary" onclick="location.reload()">
                                <i class="fas fa-arrow-left"></i> Download Another Video
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features -->
                <div class="row mt-4">
                    <div class="col-md-3 text-center">
                        <i class="fas fa-hd-video fa-2x text-primary mb-2"></i>
                        <h6>High Quality</h6>
                        <small class="text-muted">Up to 8K resolution</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <i class="fas fa-bolt fa-2x text-warning mb-2"></i>
                        <h6>Real-time Progress</h6>
                        <small class="text-muted">Live download tracking</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <i class="fas fa-folder fa-2x text-info mb-2"></i>
                        <h6>Custom Location</h6>
                        <small class="text-muted">Choose download folder</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <i class="fas fa-music fa-2x text-success mb-2"></i>
                        <h6>Audio/Video</h6>
                        <small class="text-muted">Separate downloads</small>
                    </div>
                </div>
            </div>
        </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Direct inline script - no external dependencies -->
    <script>
        console.log('ðŸŽ¥ Direct inline script loading...');
        
        let selectedStream = null;
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready, setting up event listeners...');
            
            const fetchBtn = document.getElementById('fetchInfoBtn');
            if (fetchBtn) {
                fetchBtn.addEventListener('click', handleFetchVideoInfo);
                console.log('Fetch button event listener added');
            } else {
                console.error('Fetch button not found!');
            }
        });
        
        async function handleFetchVideoInfo() {
            console.log('=== FETCH VIDEO INFO STARTED ===');
            
            const fetchBtn = document.getElementById('fetchInfoBtn');
            const url = document.getElementById('videoUrl').value.trim();
            if (!url) {
                alert('Please enter a YouTube URL');
                return;
            }

            if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                alert('Please enter a valid YouTube URL');
                return;
            }

            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                console.log('Sending request to fetch video info...');
                
                const response = await fetch('/fetch_video_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                console.log('Response received:', data);
                
                if (data.success) {
                    console.log('Success! Processing video info...');
                    
                    // Show video info
                    document.getElementById('videoThumbnail').src = data.thumbnail;
                    document.getElementById('videoTitle').textContent = data.title;
                    document.getElementById('videoAuthor').textContent = data.author;
                    document.getElementById('videoViews').textContent = data.views.toLocaleString();
                    document.getElementById('videoDuration').textContent = Math.floor(data.length/60) + ':' + (data.length%60).toString().padStart(2,'0');
                    document.getElementById('videoDescription').textContent = data.description;
                    document.getElementById('videoInfoCard').style.display = 'block';
                    
                    console.log('Video info displayed, now adding streams...');
                    console.log('Video streams:', data.video_streams);
                    console.log('Video only streams:', data.video_only_streams);
                    console.log('Audio streams:', data.audio_streams);
                    
                    // Progressive streams (Video + Audio)
                    const progressiveContainer = document.getElementById('progressiveStreams');
                    if (progressiveContainer && data.video_streams && data.video_streams.length > 0) {
                        console.log('Adding progressive streams...');
                        let html = '';
                        data.video_streams.forEach(stream => {
                            html += `<div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="streamOption" value="${stream.itag}" data-type="progressive" id="s${stream.itag}">
                                <label class="form-check-label d-flex justify-content-between" for="s${stream.itag}">
                                    <span>${stream.resolution} (${stream.fps}fps)</span>
                                    <span class="text-muted">${stream.size_mb} MB</span>
                                </label>
                            </div>`;
                        });
                        progressiveContainer.innerHTML = html;
                        console.log('Progressive streams HTML:', html);
                    }
                    
                    // Adaptive streams (High Quality)
                    const adaptiveContainer = document.getElementById('adaptiveStreams');
                    if (adaptiveContainer && data.video_only_streams && data.video_only_streams.length > 0) {
                        console.log('Adding adaptive streams...');
                        let html = '';
                        data.video_only_streams.forEach(stream => {
                            html += `<div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="streamOption" value="${stream.itag}" data-type="adaptive" id="a${stream.itag}">
                                <label class="form-check-label d-flex justify-content-between" for="a${stream.itag}">
                                    <span>${stream.resolution} (${stream.fps}fps)</span>
                                    <span class="text-muted">${stream.size_mb} MB</span>
                                </label>
                            </div>`;
                        });
                        adaptiveContainer.innerHTML = html;
                        console.log('Adaptive streams HTML:', html);
                    }
                    
                    // Video only streams
                    const videoOnlyContainer = document.getElementById('videoOnlyStreams');
                    if (videoOnlyContainer && data.video_only_streams && data.video_only_streams.length > 0) {
                        console.log('Adding video only streams...');
                        let html = '';
                        data.video_only_streams.forEach(stream => {
                            html += `<div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="streamOption" value="${stream.itag}" data-type="video_only" id="v${stream.itag}">
                                <label class="form-check-label d-flex justify-content-between" for="v${stream.itag}">
                                    <span>${stream.resolution} (${stream.fps}fps)</span>
                                    <span class="text-muted">${stream.size_mb} MB</span>
                                </label>
                            </div>`;
                        });
                        videoOnlyContainer.innerHTML = html;
                        console.log('Video only streams HTML:', html);
                    }
                    
                    // Audio streams
                    const audioContainer = document.getElementById('audioStreams');
                    if (audioContainer && data.audio_streams && data.audio_streams.length > 0) {
                        console.log('Adding audio streams...');
                        let html = '';
                        data.audio_streams.forEach(stream => {
                            html += `<div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="streamOption" value="${stream.itag}" data-type="audio_only" id="au${stream.itag}">
                                <label class="form-check-label d-flex justify-content-between" for="au${stream.itag}">
                                    <span>${stream.quality}</span>
                                    <span class="text-muted">${stream.size_mb} MB</span>
                                </label>
                            </div>`;
                        });
                        audioContainer.innerHTML = html;
                        console.log('Audio streams HTML:', html);
                    }
                    
                    // Show download options
                    document.getElementById('downloadOptionsCard').style.display = 'block';
                    console.log('Download options card shown');
                    
                    // Add event listeners to radio buttons
                    const radios = document.querySelectorAll('input[name="streamOption"]');
                    console.log(`Found ${radios.length} radio buttons, adding event listeners...`);
                    
                    radios.forEach(radio => {
                        radio.addEventListener('change', function() {
                            if (this.checked) {
                                selectedStream = {
                                    itag: this.value,
                                    type: this.dataset.type
                                };
                                document.getElementById('downloadBtn').disabled = false;
                                console.log('Stream selected:', selectedStream);
                            }
                        });
                    });
                    
                    console.log('=== SETUP COMPLETE ===');
                    
                } else {
                    console.error('Error in response:', data.error);
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Error: ' + error.message);
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i class="fas fa-search"></i> Fetch Video Info';
            }
        }
    </script>
</body>
</html>